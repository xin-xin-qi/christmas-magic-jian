<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merry Christmas & Happy New Year</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; transition: background 1s ease; }
        body.bg-black { background: #000; }
        body.bg-deep { background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }
        body.bg-warm { background: radial-gradient(circle at center, #2e1a1a 0%, #0f0505 100%); }
        body.bg-aurora { background: radial-gradient(circle at top, #0f2027 0%, #203a43 50%, #2c5364 100%); }
        body.bg-china { background: radial-gradient(circle at center, #4a0000 0%, #1a0000 100%); }
        #main-title {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; z-index: 50; pointer-events: none; opacity: 0; transition: opacity 1s;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        .title-xmas {
            font-family: 'Great Vibes', cursive; font-size: 5rem;
            background: linear-gradient(to bottom, #ffd700, #ffec8b);
        }
        .title-cny {
            font-family: 'Ma Shan Zheng', cursive; font-size: 5rem;
            background: linear-gradient(to bottom, #ff3333, #ffd700);
            text-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            letter-spacing: 10px;
        }
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #fff;
        }
        #btn-start {
            padding: 15px 50px; font-size: 20px; background: linear-gradient(90deg, #ffd700, #ffaa00);
            border: none; border-radius: 30px; color: #000; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); margin-top: 30px; transition: transform 0.2s;
        }
        #btn-start:hover { transform: scale(1.05); }
        #photo-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            max-width: 80%; max-height: 80%; background: #fff; padding: 10px 10px 40px 10px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); z-index: 150;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 4px;
        }
        #photo-modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(-3deg); }
        #photo-modal img { max-width: 100%; max-height: 60vh; display: block; }
        #photo-caption { text-align: center; color: #333; font-family: 'Great Vibes', cursive; font-size: 2rem; margin-top: 5px; }
        #status-bar {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 14px; text-shadow: 0 2px 4px #000; pointer-events: none;
            background: rgba(0,0,0,0.3); padding: 5px 0; z-index: 95;
        }
        #ui-panel {
            position: absolute; top: 100px; right: 20px; width: 280px;
            max-height: 80vh; overflow-y: auto;
            background: rgba(15, 15, 20, 0.85); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 12px; color: #fff;
            border: 1px solid rgba(255,255,255,0.15); z-index: 100;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #ui-panel.hidden { transform: translateX(130%); }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 11px; color: #ccc; margin-bottom: 4px; }
        input[type=range] { width: 100%; accent-color: #ffd700; cursor: pointer; }
        .btn { width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; border-radius: 6px; font-size: 12px; margin-bottom: 5px; }
        .btn:hover { background: rgba(255,255,255,0.2); }
        .btn.active { background: linear-gradient(90deg, #ff7675, #d63031); border:none; font-weight:bold; }
        select { width: 100%; padding: 6px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; }
        #toggle-btn {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            background: rgba(255,255,255,0.1); border-radius: 50%; color: #fff;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer; z-index: 101;
            display: flex; justify-content: center; align-items: center; font-size: 18px;
        }
        #input_video {
            position: absolute; bottom: 20px; left: 20px;
            width: 200px; height: 150px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: scaleX(-1);
            z-index: 90;
            object-fit: cover;
            transition: opacity 0.5s ease;
        }
        #input_video.hidden-cam { opacity: 0; pointer-events: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body class="bg-black">
    <div id="main-title" class="title-xmas">Merry Christmas</div>
    <div id="status-bar">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
    <div id="start-screen">
        <h1 style="font-family: 'Great Vibes'; font-size: 4rem; color: #ffd700; margin: 0;">Magic Holiday</h1>
        <div style="margin-top:20px; text-align:center; color:#aaa; font-size:16px; line-height:1.8;">
            â¬…ï¸ <strong>å·¦æ‰‹</strong>ï¼šå¼ å¼€æ‰‹æŒæ§åˆ¶çˆ†ç‚¸<br>
            â¡ï¸ <strong>å³æ‰‹</strong>ï¼šåŒæŒ‡æåˆæå–ç…§ç‰‡
        </div>
        <button id="btn-start">å¼€å§‹ä½“éªŒ âœ¨</button>
    </div>
    <div id="photo-modal">
        <img id="modal-img" src="" alt="Memory">
        <div id="photo-caption">Sweet Memory</div>
    </div>
    <!-- é¢„åŠ è½½ç…§ç‰‡ï¼ˆéšè—ï¼Œä½†ä¼šè¢«JSåŠ è½½ï¼‰ -->
    <div id="preloaded-photos" style="display:none;">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3780.jpg" alt="æˆ‘çš„ç…§ç‰‡ 1">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3796.jpg" alt="æˆ‘çš„ç…§ç‰‡ 2">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3800.jpg" alt="æˆ‘çš„ç…§ç‰‡ 3">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3810.jpg" alt="æˆ‘çš„ç…§ç‰‡ 4">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3822.jpg" alt="æˆ‘çš„ç…§ç‰‡ 5">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3842.jpg" alt="æˆ‘çš„ç…§ç‰‡ 6">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3849.jpg" alt="æˆ‘çš„ç…§ç‰‡ 7">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3861.jpg" alt="æˆ‘çš„ç…§ç‰‡ 8">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3873.jpg" alt="æˆ‘çš„ç…§ç‰‡ 9">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3928.jpg" alt="æˆ‘çš„ç…§ç‰‡ 10">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3934.jpg" alt="æˆ‘çš„ç…§ç‰‡ 11">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3945.jpg" alt="æˆ‘çš„ç…§ç‰‡ 12">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I3980.jpg" alt="æˆ‘çš„ç…§ç‰‡ 13">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4018.jpg" alt="æˆ‘çš„ç…§ç‰‡ 14">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4064.jpg" alt="æˆ‘çš„ç…§ç‰‡ 15">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4078.jpg" alt="æˆ‘çš„ç…§ç‰‡ 16">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4081.jpg" alt="æˆ‘çš„ç…§ç‰‡ 17">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4133.jpg" alt="æˆ‘çš„ç…§ç‰‡ 18">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4153.jpg" alt="æˆ‘çš„ç…§ç‰‡ 19">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4167.jpg" alt="æˆ‘çš„ç…§ç‰‡ 20">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4175.jpg" alt="æˆ‘çš„ç…§ç‰‡ 21">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4178.jpg" alt="æˆ‘çš„ç…§ç‰‡ 22">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4183.jpg" alt="æˆ‘çš„ç…§ç‰‡ 23">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4229.jpg" alt="æˆ‘çš„ç…§ç‰‡ 24">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4236.jpg" alt="æˆ‘çš„ç…§ç‰‡ 25">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4247.jpg" alt="æˆ‘çš„ç…§ç‰‡ 26">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4265.jpg" alt="æˆ‘çš„ç…§ç‰‡ 27">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4281.jpg" alt="æˆ‘çš„ç…§ç‰‡ 28">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4291.jpg" alt="æˆ‘çš„ç…§ç‰‡ 29">
        <img src="https://raw.githubusercontent.com/xin-xin-qi/christmas-magic-jian/main/photos/D25I4312.jpg" alt="æˆ‘çš„ç…§ç‰‡ 30">
    </div>
    <button id="toggle-btn">âš™ï¸</button>
    <video id="input_video" class="hidden-cam"></video>
    <div id="ui-panel">
        <h3 style="margin:0 0 15px 0; color:#ffd700; border-bottom:1px solid #444; padding-bottom:10px;">ğŸ¨ é£æ ¼ä¸æ§åˆ¶</h3>
        <div class="control-group">
            <button id="btn-fullscreen" class="btn">â›¶ è¿›å…¥å…¨å±æ¨¡å¼</button>
        </div>
        <div class="control-group">
            <label style="color:#ffd700; font-weight:bold; margin-bottom:8px;">é€‰æ‹©ä¸»é¢˜é£æ ¼</label>
            <div style="display:flex; gap:10px;">
                <button id="theme-xmas" class="btn active">ğŸ„ åœ£è¯</button>
                <button id="theme-cny" class="btn">ğŸ§§ æ–°æ˜¥</button>
            </div>
        </div>
        <div class="control-group">
            <label>è¾…åŠ©æ˜¾ç¤º</label>
            <button id="btn-toggle-cam" class="btn" style="background:rgba(255,255,255,0.15)">ğŸ“¹ æ˜¾ç¤º/éšè— æ‘„åƒå¤´</button>
        </div>
        <div class="control-group">
            <label>èƒŒæ™¯é¢œè‰²</label>
            <select id="bg-select">
                <option value="black">ğŸŒŒ çº¯é»‘ (Black)</option>
                <option value="deep">ğŸŒƒ æ·±é‚ƒ (Deep Blue)</option>
                <option value="warm">ğŸ”¥ æš–å†¬ (Warm)</option>
                <option value="aurora">â„ï¸ æå…‰ (Aurora)</option>
                <option value="china">ğŸ§§ ä¸­å›½çº¢ (China Red)</option>
            </select>
        </div>
        <div class="control-group">
            <label>èƒŒæ™¯éŸ³ä¹</label>
            <button class="btn" onclick="document.getElementById('music-input').click()">ğŸ“ æ¢éŸ³ä¹ (MP3)</button>
            <input type="file" id="music-input" accept="audio/*" style="display:none;">
            <div style="display:flex; gap:10px; margin-top:5px;">
                <button id="btn-play-pause" class="btn" style="width:40px;">â¸</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.6">
            </div>
        </div>
        <div class="control-group">
            <label>ç…§ç‰‡ç®¡ç†</label>
            <button class="btn" style="background:linear-gradient(90deg, #00b894, #00cec9); color:black; font-weight:bold;" onclick="document.getElementById('folder-input').click()">ğŸ“· å¯¼å…¥ç…§ç‰‡ (å¤šé€‰)</button>
            <input type="file" id="folder-input" multiple accept="image/*" style="display:none;">
        </div>
        <div class="control-group">
            <label>æ—‹è½¬é€Ÿåº¦ <span id="val-rot">0.002</span></label>
            <input type="range" id="rot-speed" min="0" max="0.02" step="0.001" value="0.002">
        </div>
        <div class="control-group">
            <label>æ ‘çš„é«˜åº¦</label>
            <input type="range" id="tree-height" min="40" max="100" step="5" value="70">
        </div>
        <div class="control-group">
            <label>éŸ³ä¹å¾‹åŠ¨</label>
            <input type="range" id="beat-sense" min="0.1" max="3.0" step="0.1" value="1.0">
        </div>
    </div>
    <script type="x-shader/x-vertex" id="vertexshader">
        attribute float size; attribute vec3 customColor; attribute vec3 spherePos; attribute float type;     
        varying vec3 vColor; varying float vType;
        uniform float uTime; uniform float uExplosion; uniform float uBeat;      
        void main() {
            vColor = customColor; vType = type;
            float t = uExplosion;
            float ease = 1.0 - pow(1.0 - t, 3.0);
            vec3 finalPos = mix(position, spherePos, ease);
            float beatScale = 1.0;
            if (t < 0.2) beatScale += uBeat * 0.15 * (1.0 - t*3.0); 
            if (type > 0.5) beatScale += uBeat * 0.2; 
            vec4 mvPosition = modelViewMatrix * vec4(finalPos * beatScale, 1.0);
            float s = size;
            if(type > 0.5) s *= (1.0 + uBeat * 0.5);
            gl_PointSize = s * (300.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshader">
        uniform float uTime; uniform float uBeat;
        varying vec3 vColor; varying float vType;
        void main() {
            vec2 coord = gl_PointCoord - vec2(0.5);
            if(length(coord) > 0.5) discard;
            vec3 color = vColor; float alpha = 1.0;
            if(vType > 0.5) {
                float flash = 0.5 + 0.5 * sin(uTime * 5.0 + vType * 10.0);
                color += vec3(0.5) * flash * uBeat * 2.0;
            } else { alpha = 0.8; }
            gl_FragColor = vec4(color, alpha);
        }
    </script>
    <script>
        const state = { 
            explosion: 0.0, targetExplosion: 0.0, photoActive: false, treeHeight: 70, rotationSpeed: 0.002,
            style: 'xmas'
        };
        let scene, camera, renderer, clock;
        let particleSystem, treeGroup, topDecoration;
        let photoMeshes = [], loadedImages = [];
        let audioCtx, analyser, dataArray, audioEl;
        
        document.getElementById('btn-start').addEventListener('click', () => {
            const screen = document.getElementById('start-screen');
            screen.style.opacity = 0;
            setTimeout(() => screen.remove(), 1000);
            document.getElementById('main-title').style.opacity = 1;
            document.getElementById('input_video').classList.remove('hidden-cam');
            initAudio();
            initThree();
            setupUI();
            startHandTracking();
        });
        
        function initAudio() {
            audioEl = new Audio();
            audioEl.crossOrigin = "anonymous";
            audioEl.src = "https://thirdparty.gtimg.com/C1000007bNrR1HXkjD.m4a?fromtag=38";
            audioEl.loop = true;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            const source = audioCtx.createMediaElementSource(audioEl);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            audioEl.play().catch(e => console.log(e));
        }
        
        function initThree() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.004);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 90);
            camera.lookAt(0, 30, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            treeGroup = new THREE.Group();
            scene.add(treeGroup);
            
            createParticles();
            createTopObject();
            createSnow();
            animate();
            
            // ========== ä¿®å¤ï¼šç§»é™¤é‡å¤çš„ç…§ç‰‡å¤„ç†ä»£ç ï¼Œåªä¿ç•™ä¸€ä¸ª ==========
            setTimeout(() => {
                const preloaded = document.getElementById('preloaded-photos');
                if(preloaded) {
                    const imgs = preloaded.getElementsByTagName('img');
                    loadedImages = [];
                    
                    // è®¡æ•°å™¨ï¼Œç¡®ä¿æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
                    let loadedCount = 0;
                    const totalImages = imgs.length;
                    
                    Array.from(imgs).forEach((imgElement) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.src = imgElement.src;
                        
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const ctx = canvas.getContext('2d');
                            
                            // åˆ›å»ºåœ†å½¢è£å‰ªåŒºåŸŸ
                            ctx.beginPath();
                            ctx.arc(128, 128, 120, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();
                            
                            // è®¡ç®—å¹¶ç»˜åˆ¶å›¾ç‰‡ï¼ˆä¿æŒæ¯”ä¾‹å±…ä¸­ï¼‰
                            const asp = img.width / img.height;
                            let drawWidth, drawHeight, offsetX, offsetY;
                            
                            if (asp > 1) {
                                // å®½å›¾
                                drawHeight = img.height;
                                drawWidth = img.height;
                                offsetX = (img.width - img.height) / 2;
                                offsetY = 0;
                            } else {
                                // é«˜å›¾æˆ–æ–¹å›¾
                                drawWidth = img.width;
                                drawHeight = img.width;
                                offsetX = 0;
                                offsetY = (img.height - img.width) / 2;
                            }
                            
                            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight, 0, 0, 256, 256);
                            
                            // ç»˜åˆ¶åœ†å½¢è¾¹æ¡†ï¼ˆæ ¹æ®å½“å‰ä¸»é¢˜é£æ ¼ï¼‰
                            ctx.lineWidth = 10;
                            ctx.strokeStyle = state.style === 'cny' ? '#ffd700' : '#ffffff';
                            ctx.stroke();
                            
                            // åˆ›å»ºå¤„ç†å¥½çš„å›¾ç‰‡å¯¹è±¡
                            const processedImage = new Image();
                            processedImage.src = canvas.toDataURL('image/png');
                            
                            processedImage.onload = () => {
                                loadedImages.push(processedImage);
                                loadedCount++;
                                
                                // å½“æ‰€æœ‰ç…§ç‰‡éƒ½å¤„ç†å®Œæ¯•æ—¶ï¼Œè°ƒç”¨updatePhotos
                                if (loadedCount === totalImages) {
                                    console.log(`æ‰€æœ‰ ${loadedImages.length} å¼ ç…§ç‰‡å·²å¤„ç†å®Œæˆï¼Œå‡†å¤‡æŒ‚è½½ã€‚`);
                                    updatePhotos();
                                }
                            };
                        };
                        
                        img.onerror = (err) => {
                            console.error('é¢„åŠ è½½å›¾ç‰‡å¤±è´¥:', imgElement.src, err);
                            loadedCount++; // å³ä½¿å¤±è´¥ä¹Ÿè¦è®¡æ•°ï¼Œé˜²æ­¢å¡ä½
                        };
                    });
                }
            }, 1000);
        }
        
        function createParticles() {
            // ä¿®å¤ï¼šå®Œå–„èµ„æºé‡Šæ”¾æœºåˆ¶
            if(particleSystem) {
                treeGroup.remove(particleSystem);
                if(particleSystem.geometry) {
                    particleSystem.geometry.dispose();
                }
                if(particleSystem.material) {
                    particleSystem.material.dispose();
                    // æ¸…ç†uniformså¼•ç”¨
                    if(particleSystem.material.uniforms) {
                        for(const key in particleSystem.material.uniforms) {
                            particleSystem.material.uniforms[key] = null;
                        }
                    }
                }
            }
            
            const count = 18000;
            const geo = new THREE.BufferGeometry();
            const positions = [], spherePos = [], colors = [], sizes = [], types = [];
            const h = state.treeHeight;
            const colorHelper = new THREE.Color();
            
            for(let i=0; i<count; i++) {
                const y = (i/count) * h;
                const rBase = (1 - y/h) * (h*0.4);
                const angle = i * 0.2;
                const r = rBase * Math.sqrt(Math.random());
                positions.push(Math.cos(angle)*r, y - 10, Math.sin(angle)*r);
                
                const v = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize();
                v.multiplyScalar(40 + Math.random()*50);
                spherePos.push(v.x, v.y + 20, v.z);
                
                const rnd = Math.random();
                let type = 0;
                
                if (state.style === 'cny') {
                    if(rnd > 0.95) {
                        type = 2;
                        sizes.push(4);
                        colorHelper.setHex(0xffd700);
                    } else if(rnd > 0.85) {
                        type = 1;
                        sizes.push(5);
                        colorHelper.setHex(0xff0000);
                    } else {
                        type = 0;
                        sizes.push(1.5);
                        if(Math.random()>0.5) colorHelper.setHex(0xffcc00);
                        else colorHelper.setHex(0xffaa00);
                    }
                } else {
                    if(rnd > 0.96) {
                        type = 2;
                        sizes.push(4);
                        colorHelper.setHex(0xffaa00);
                    } else if(rnd > 0.92) {
                        type = 1;
                        sizes.push(3);
                        colorHelper.setHex(Math.random()>0.5?0xff0000:0x00aaff);
                    } else {
                        type = 0;
                        sizes.push(1.5);
                        colorHelper.setHex(0x228b22);
                    }
                }
                
                types.push(type);
                colors.push(colorHelper.r, colorHelper.g, colorHelper.b);
            }
            
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('spherePos', new THREE.Float32BufferAttribute(spherePos, 3));
            geo.setAttribute('customColor', new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geo.setAttribute('type', new THREE.Float32BufferAttribute(types, 1));
            
            state.uniforms = {
                uTime: { value: 0 },
                uExplosion: { value: 0 },
                uBeat: { value: 0 }
            };
            
            const mat = new THREE.ShaderMaterial({
                uniforms: state.uniforms,
                vertexShader: document.getElementById('vertexshader').textContent,
                fragmentShader: document.getElementById('fragmentshader').textContent,
                blending: THREE.AdditiveBlending,
                depthTest: false,
                transparent: true
            });
            
            particleSystem = new THREE.Points(geo, mat);
            treeGroup.add(particleSystem);
        }
        
        function createTopObject() {
            if(topDecoration) {
                treeGroup.remove(topDecoration);
                // æ¸…ç†æ—§è£…é¥°çš„èµ„æº
                if(topDecoration.children) {
                    topDecoration.children.forEach(child => {
                        if(child.geometry) child.geometry.dispose();
                        if(child.material) child.material.dispose();
                    });
                }
            }
            
            if(state.style === 'xmas') {
                const s = new THREE.Shape();
                const p = 5;
                for(let i=0; i<p*2; i++) {
                    const r = (i%2===0) ? 4 : 2;
                    const a = i/p * Math.PI;
                    s.lineTo(Math.cos(a)*r, Math.sin(a)*r);
                }
                const g = new THREE.ExtrudeGeometry(s, {
                    depth: 1,
                    bevelEnabled: true,
                    bevelThickness: 0.5,
                    bevelSize: 0.2
                });
                topDecoration = new THREE.Mesh(g, new THREE.MeshBasicMaterial({color: 0xffdd00}));
            } else {
                topDecoration = new THREE.Group();
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(3.5, 32, 32), new THREE.MeshBasicMaterial({color: 0xff0000}));
                sphere.scale.set(1, 0.8, 1);
                
                const cap1 = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 0.5, 32), new THREE.MeshBasicMaterial({color: 0xffd700}));
                cap1.position.y = 2.6;
                
                const cap2 = cap1.clone();
                cap2.position.y = -2.6;
                
                const tasselGeo = new THREE.CylinderGeometry(0.2, 0.2, 8, 8);
                const tasselMat = new THREE.MeshBasicMaterial({color: 0xff3300});
                const t1 = new THREE.Mesh(tasselGeo, tasselMat);
                t1.position.set(0, -6, 0);
                
                const t2 = t1.clone();
                t2.position.set(1, -6, 0);
                t2.rotation.z = 0.2;
                
                const t3 = t1.clone();
                t3.position.set(-1, -6, 0);
                t3.rotation.z = -0.2;
                
                topDecoration.add(sphere, cap1, cap2, t1, t2, t3);
            }
            
            topDecoration.position.y = state.treeHeight;
            treeGroup.add(topDecoration);
        }
        
        function createSnow() {
            const g = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1000; i++) {
                pos.push(
                    (Math.random()-0.5) * 200,
                    Math.random() * 150,
                    (Math.random()-0.5) * 200
                );
            }
            g.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            window.snowSystem = new THREE.Points(g, new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.6,
                transparent: true,
                opacity: 0.6
            }));
            scene.add(window.snowSystem);
        }
        
        function updatePhotos() {
            // æ¸…ç†æ—§çš„ç…§ç‰‡ç½‘æ ¼
            photoMeshes.forEach(m => {
                treeGroup.remove(m);
                if(m.geometry) m.geometry.dispose();
                if(m.material) {
                    if(m.material.map) m.material.map.dispose();
                    m.material.dispose();
                }
            });
            photoMeshes = [];
            
            if(loadedImages.length === 0) return;
            
            loadedImages.forEach(img => {
                const cvs = document.createElement('canvas');
                cvs.width = 256;
                cvs.height = 256;
                const ctx = cvs.getContext('2d');
                
                // åˆ›å»ºåœ†å½¢è£å‰ªåŒºåŸŸ
                ctx.beginPath();
                ctx.arc(128, 128, 120, 0, Math.PI*2);
                ctx.clip();
                
                // è®¡ç®—å¹¶ç»˜åˆ¶å›¾ç‰‡
                const asp = img.width/img.height;
                if(asp > 1) {
                    ctx.drawImage(img, (img.width-img.height)/2, 0, img.height, img.height, 0, 0, 256, 256);
                } else {
                    ctx.drawImage(img, 0, (img.height-img.width)/2, img.width, img.width, 0, 0, 256, 256);
                }
                
                // ä¿®å¤ï¼šç¡®ä¿è¾¹æ¡†é¢œè‰²ä¸ä¸»é¢˜ä¸€è‡´
                ctx.lineWidth = 10;
                ctx.strokeStyle = state.style === 'cny' ? '#ffd700' : '#ffffff';
                ctx.stroke();
                
                const mesh = new THREE.Mesh(
                    new THREE.PlaneGeometry(6,6),
                    new THREE.MeshBasicMaterial({
                        map: new THREE.CanvasTexture(cvs),
                        side: THREE.DoubleSide,
                        transparent: true,
                        depthWrite: false,
                        depthTest: false
                    })
                );
                
                const y = Math.random() * (state.treeHeight * 0.8);
                const r = (1 - y/state.treeHeight) * (state.treeHeight*0.4) + 2;
                const a = Math.random() * Math.PI * 2;
                const origin = new THREE.Vector3(Math.cos(a)*r, y-10, Math.sin(a)*r);
                const explodeDir = origin.clone().normalize().multiplyScalar(40 + Math.random()*30);
                explodeDir.y += 20;
                
                mesh.position.copy(origin);
                mesh.userData = {
                    origin: origin,
                    explodePos: explodeDir,
                    imgSrc: img.src
                };
                
                treeGroup.add(mesh);
                photoMeshes.push(mesh);
            });
            
            document.getElementById('status-bar').innerText = `å·²æŒ‚è½½ ${loadedImages.length} å¼ ç…§ç‰‡åˆ°${state.style === 'cny' ? 'æ–°æ˜¥æ ‘' : 'åœ£è¯æ ‘'}ä¸Š`;
            setTimeout(() => {
                document.getElementById('status-bar').innerText = "ç­‰å¾…åŒæ‰‹è¯†åˆ«...";
            }, 3000);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();
            
            // éŸ³é¢‘èŠ‚æ‹åˆ†æ
            let beat = 0;
            if(analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<15; i++) sum += dataArray[i];
                beat = (sum/15/255) * parseFloat(document.getElementById('beat-sense').value);
            }
            
            // æ›´æ–°ç€è‰²å™¨uniforms
            if(state.uniforms) {
                state.uniforms.uTime.value = t;
                state.uniforms.uBeat.value = beat;
                state.explosion += (state.targetExplosion - state.explosion) * 0.05;
                state.uniforms.uExplosion.value = state.explosion;
            }
            
            // æ›´æ–°ç…§ç‰‡ä½ç½®ï¼ˆçˆ†ç‚¸æ•ˆæœï¼‰
            const ease = 1.0 - Math.pow(1.0 - state.explosion, 3.0);
            photoMeshes.forEach(p => {
                p.position.lerpVectors(p.userData.origin, p.userData.explodePos, ease);
                p.lookAt(camera.position);
                p.rotation.z += 0.005 * (1 + state.explosion * 5);
            });
            
            // æ—‹è½¬æ ‘
            treeGroup.rotation.y += state.rotationSpeed + state.explosion * 0.01;
            
            // æ›´æ–°é¡¶éƒ¨è£…é¥°
            if(topDecoration) {
                if(state.style === 'xmas') {
                    topDecoration.rotation.y -= 0.02;
                } else {
                    topDecoration.rotation.z = Math.sin(t * 2) * 0.1;
                }
                const s = 1 + beat * 0.3;
                topDecoration.scale.set(s, s, s);
            }
            
            // æ›´æ–°é›ªèŠ±
            if(window.snowSystem) {
                const pos = window.snowSystem.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) {
                    pos[i] -= 0.3;
                    if(pos[i] < -20) pos[i] = 100;
                }
                window.snowSystem.geometry.attributes.position.needsUpdate = true;
            }
            
            renderer.render(scene, camera);
        }
        
        function startHandTracking() {
            const video = document.getElementById('input_video');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(results => {
                const status = document.getElementById('status-bar');
                let statusText = "";
                let leftFound = false;
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    for (let i = 0; i < results.multiHandedness.length; i++) {
                        const label = results.multiHandedness[i].label;
                        const lm = results.multiHandLandmarks[i];
                        
                        if (label === 'Left') {
                            leftFound = true;
                            const d = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                            state.targetExplosion = Math.min(Math.max((d - 0.15) * 4, 0), 1);
                            statusText += `ğŸ–ï¸ å·¦æ‰‹: ${state.targetExplosion > 0.5 ? "çˆ†ç‚¸" : "è¿˜åŸ"}  `;
                        }
                        
                       if (label === 'Right') {
    const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
    
    // æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ ‡è®°ï¼Œè®°å½•ä¸Šä¸€æ¬¡æ˜¯å¦æ˜¯æåˆçŠ¶æ€
    if (!window.lastPinchState) window.lastPinchState = false;
    
    if (pinchDist < 0.05) {
        // åªæœ‰åœ¨ä»"éæåˆ"å˜ä¸º"æåˆ"æ—¶æ‰è§¦å‘
        if (!window.lastPinchState) {
            if (!state.photoActive) {
                showRandomPhoto();
                state.photoActive = true;
            }
            window.lastPinchState = true; // æ ‡è®°ä¸ºå·²æåˆ
        }
        statusText += `| ğŸ‘Œ å³æ‰‹: æåˆæå– `;
    } else if (pinchDist > 0.08) {
        if (state.photoActive) {
            document.getElementById('photo-modal').classList.remove('active');
            state.photoActive = false;
        }
        window.lastPinchState = false; // é‡ç½®æåˆçŠ¶æ€
        statusText += `| âœ‹ å³æ‰‹: æ¾å¼€ `;
    } else {
        statusText += `| âœ‹ å³æ‰‹: å°±ç»ª `;
        window.lastPinchState = false; // ä¸­é—´çŠ¶æ€ä¹Ÿé‡ç½®
    }
}
                    }
                } else {
                    statusText = "ğŸ‘€ ç­‰å¾…åŒæ‰‹...";
                }
                
                if (!leftFound) state.targetExplosion = 0;
                status.innerText = statusText;
            });
            
            const cameraUtils = new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                },
                width: 320,
                height: 240
            });
            cameraUtils.start();
        }
        
        function showRandomPhoto() {
    if(loadedImages.length === 0) return;
    
    // 1. å…ˆå°è¯•è·å–é¢„åŠ è½½çš„åŸå§‹å›¾ç‰‡
    const preloadedDiv = document.getElementById('preloaded-photos');
    if(preloadedDiv) {
        const originalImgs = preloadedDiv.getElementsByTagName('img');
        if(originalImgs.length > 0) {
            // éšæœºé€‰æ‹©ä¸€å¼ åŸå§‹å›¾ç‰‡
            const randomIndex = Math.floor(Math.random() * originalImgs.length);
            const originalImg = originalImgs[randomIndex];
            
            document.getElementById('modal-img').src = originalImg.src;
            document.getElementById('photo-modal').classList.add('active');
            return; // é‡è¦ï¼šæ‰¾åˆ°å°±è¿”å›ï¼Œä¸å†æ‰§è¡Œåé¢çš„ä»£ç 
        }
    }
    
    // 2. å¦‚æœæ²¡æœ‰é¢„åŠ è½½å›¾ç‰‡ï¼ˆç†è®ºä¸Šä¸ä¼šåˆ°è¿™é‡Œï¼‰ï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
    const img = loadedImages[Math.floor(Math.random() * loadedImages.length)];
    document.getElementById('modal-img').src = img.src;
    document.getElementById('photo-modal').classList.add('active');
}
        
        function setupUI() {
            // å…¨å±æŒ‰é’®
            const fsBtn = document.getElementById('btn-fullscreen');
            fsBtn.addEventListener('click', () => {
                if(!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    fsBtn.innerText = "âŒ é€€å‡ºå…¨å±æ¨¡å¼";
                } else {
                    document.exitFullscreen();
                    fsBtn.innerText = "â›¶ è¿›å…¥å…¨å±æ¨¡å¼";
                }
            });
            
            // æ‘„åƒå¤´åˆ‡æ¢
            document.getElementById('btn-toggle-cam').addEventListener('click', () => {
                document.getElementById('input_video').classList.toggle('hidden-cam');
            });
            
            // èƒŒæ™¯é€‰æ‹©
            document.getElementById('bg-select').addEventListener('change', (e) => {
                document.body.className = 'bg-'+e.target.value;
            });
            
            // UIé¢æ¿åˆ‡æ¢
            document.getElementById('toggle-btn').addEventListener('click', () => {
                document.getElementById('ui-panel').classList.toggle('hidden');
            });
            
            // æ—‹è½¬é€Ÿåº¦
            document.getElementById('rot-speed').addEventListener('input', (e) => {
                state.rotationSpeed = parseFloat(e.target.value);
                document.getElementById('val-rot').innerText = state.rotationSpeed.toFixed(3);
            });
            
            // éŸ³ä¹æ§åˆ¶
            document.getElementById('music-input').addEventListener('change', (e) => {
                if(e.target.files[0]) {
                    audioEl.src = URL.createObjectURL(e.target.files[0]);
                    audioEl.play();
                }
            });
            
            document.getElementById('btn-play-pause').addEventListener('click', () => {
                if(audioEl.paused) {
                    audioEl.play();
                    document.getElementById('btn-play-pause').innerText = "â¸";
                } else {
                    audioEl.pause();
                    document.getElementById('btn-play-pause').innerText = "â–¶";
                }
            });
            
            document.getElementById('volume-slider').addEventListener('input', (e) => {
                audioEl.volume = e.target.value;
            });
            
            // ç…§ç‰‡å¯¼å…¥
            document.getElementById('folder-input').addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                loadedImages = [];
                let loadedCount = 0;
                
                files.slice(0, 30).forEach(f => { // é™åˆ¶æœ€å¤š30å¼ 
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const img = new Image();
                        img.onload = () => {
                            loadedImages.push(img);
                            loadedCount++;
                            if(loadedCount === Math.min(files.length, 30)) {
                                updatePhotos();
                            }
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(f);
                });
            });
            
            // æ ‘çš„é«˜åº¦
            document.getElementById('tree-height').addEventListener('input', (e) => {
                state.treeHeight = parseInt(e.target.value);
                createParticles();
                if(topDecoration) topDecoration.position.y = state.treeHeight;
            });
            
            // èŠ‚æ‹æ„Ÿåº”
            document.getElementById('beat-sense').addEventListener('input', (e) => {
                document.getElementById('beat-sense').value = e.target.value;
            });
            
            // ä¸»é¢˜åˆ‡æ¢
            const switchTheme = (type) => {
                state.style = type;
                const title = document.getElementById('main-title');
                
                if(type === 'xmas') {
                    title.innerText = 'Merry Christmas';
                    title.className = 'title-xmas';
                    document.body.className = 'bg-black';
                    document.getElementById('bg-select').value = 'black';
                    document.getElementById('theme-xmas').classList.add('active');
                    document.getElementById('theme-cny').classList.remove('active');
                } else {
                    title.innerText = 'æ–°æ˜¥å¿«ä¹ ä¸‡äº‹å¦‚æ„';
                    title.className = 'title-cny';
                    document.body.className = 'bg-china';
                    document.getElementById('bg-select').value = 'china';
                    document.getElementById('theme-cny').classList.add('active');
                    document.getElementById('theme-xmas').classList.remove('active');
                }
                
                // é‡æ–°åˆ›å»ºç²’å­å’Œé¡¶éƒ¨è£…é¥°
                createParticles();
                createTopObject();
                
                // æ›´æ–°ç…§ç‰‡è¾¹æ¡†é¢œè‰²
                if(loadedImages.length > 0) {
                    updatePhotos();
                }
            };
            
            document.getElementById('theme-xmas').addEventListener('click', () => switchTheme('xmas'));
            document.getElementById('theme-cny').addEventListener('click', () => switchTheme('cny'));
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
</body>
</html>
